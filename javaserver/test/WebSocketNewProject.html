<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html>
	<head>
		<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
		<title>Creating a new project based on a websocket connection</title>
		<script src="js/lib/require.js"></script>
		<script>
			appendHyperlink = function(element, referred, reftxt){
				var main=document.getElementById(element);
				var hlink = document.createElement('a');
				hlink.href = referred;
				var inner = document.createTextNode(reftxt);
				hlink.appendChild(inner);
				main.appendChild(hlink);
			}
			appendTextLine = function(element, line){
				var main = document.getElementById(element);
				var nl = document.createElement('br');
				var txt = document.createTextNode(line);
				main.appendChild(txt);
				main.appendChild(nl);
			}
			require(["js/gmestorage_ws"], function(storage) {
				//we create a project and put some object into it
				var project = storage.createProject();
				appendTextLine("logfield","project have been created...");
				project.onopen = function(){
					appendTextLine("logfield","the project have been opened which means the websocket connection is live");
					
					var request = project.createRequest();
					appendTextLine("logfield","a request to manipulating objects have been created to the project...");
					request.ondone = function(){
						appendTextLine("logfield","");
						appendTextLine("logfield","here are the objects from the requet: "+JSON.stringify(this.objects));
						appendTextLine("logfield","");
						appendTextLine("logfield","now we close the project");
						project.close();
					}
					var root = {}; root.name="my root";root.children=[];
					var rhash = request.saveObject(root);
					appendTextLine("logfield","root have been saved into the request and its hash "+rhash+" have been returned");
					request.saveRoot(rhash);
					appendTextLine("logfield","now the root have been set in the project and in the request");
					for(var i=0;i<10;i++){
						var child = {}; child.name = i.toString(); child.children=[];
						var chash = request.saveObject(child);
						appendTextLine("logfield","new child have been saved to the request and its hash "+chash+" have been returned");
						root.children.push(chash);
						appendTextLine("logfield","the children have been connected to the root");
					}
					rhash = request.saveObject(root);
					appendTextLine("logfield","the root have been saved once more as it changed!!! and the new hash is: "+rhash);
					request.saveRoot(rhash);
					appendTextLine("logfield","and the root is set to this new hash as well");
					appendTextLine("logfield","");
					appendTextLine("logfield","now we send the request - which has no use in this context, but could be done");
					request.send();				
				}
				project.onclose = function(){
					appendTextLine("logfield","the project have been closed");
					appendHyperlink("logfield","WebSocketPrintProject.html","printing project from websocket");
					appendTextLine("logfield","");
					appendHyperlink("logfield","index.html","main page");
				}
				appendTextLine("logfield","opening the project");
				project.open("ws://localhost:8081/ws");
			});
		</script>
	</head>
	<body>
		<div id="logfield">
			<h3>Here will be the information about what this page do.</h3><br/>
		</div>
	</body>
</html>