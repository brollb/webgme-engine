<html>
	<head>
		<title>WebGME quick project creator</title>
		<script src="./lib/require.js"></script>
		<script>
			var session = 0;
			require(['./gmestorage.js'], function(storage){
				createProject = function(){
					getParentPath = function(path){
						if(path.lastIndexOf('/')>0){
							return path.substr(0,path.lastIndexOf('/'));
						}
						else{
							return "root";
						}
					};
					
					createChildren = function(number,object,request){
						if(object.children.length>0){
							/*recursively call to the children*/
							for(var i in object.children){
								createChildren(number,getObjectByHash(object.children[i]),request);
							}
						}
						else{
							for(var i=0;i<number;i++){
								var child = {}; child.name = object.name+"_"+i; child.path = object.path +"/"+child.name; child.children = [];
								addChild(child,request);
							}
						}
					};
					
					addChild = function(object,request){
						var str = JSON.stringify(object);
						var hash = request.saveObject(str);
						var hasparent = true;
						/*appending to its parent which should exist*/
						var obj = getObjectByPath(getParentPath(object.path));
						var oldhash = SHA1(JSON.stringify(obj));
						obj.children.push(hash);
						hash = request.saveObject(obj);
						if(obj.path=="root"){
							hasparent = false;
						}
						/*now modifying all upper level parents*/
						while(hasparent){
							/*first we set the obj to the parent
							  then we search for oldhash among the children of parent
							  we set the oldhash to the parents old hash value
							  then we modify the given child to hash
							  finally we calculate the new hash by saving the parent to the request*/
							 obj = getObjectByPath(getParentPath(obj.path));
							 var found = false;
							 for(var i=0;i<obj.children.length && !found; i++){
							 	if(obj.children[i]==oldhash){
							 		found=true;
							 		oldhash = SHA1(JSON.stringify(obj));
							 		obj.children[i] = hash;
							 	}
							 }
							 if(found){
							 	hash = request.saveObject(obj);
							 	if(obj.path=="root"){
							 		hasparent=false;
							 		request.saveRoot(hash);
							 	}
							 }
							 else{
							 	hasparent=false;
							 }
						}
						
						
					};
					storeObject = function(object){
						mystore.hashes[SHA1(JSON.stringify(object))] = object;
						mystore.pathes[object.path] = object;
					};
					getObjectByHash = function(hash){
						return mystore.hashes[hash];
					}
					getObjectByPath = function(path){
						return mystore.pathes[path];
					}
					var numofchildren = Number(document.getElementById("NumberOfChildField").value);
					var maxnumofobjects = Number(document.getElementById("NumberOfObjectsToBeCreatedField").value);
					var mystore = {}; mystore.pathes = {}; mystore.hashes={};
					var pathes = {};
					var numofobjects = 0;
					var mysession=session;session++;
					printLogLine("Quick project creation started" , mysession);
					var myproject = storage.createProject();
					printLogLine("Opening the project",mysession);
					myproject.createnextlevel = function(){
						printLogLine("creating the next request",mysession);
						var request = myproject.createRequest();
						createChildren(numofchildren,getObjectByPath("root"),request);
						request.ondone = function(){
							printLogLine("request handled by the server",mysession);
							myproject.saverequest(this);
						}
						printLogLine("sending the request",mysession);
						request.send();
					};
					myproject.saverequest = function(request){
						printLogLine("saving object from request",mysession);
						var start = numofobjects;
						for(var i in request.objects){
							if(getObjectByPath(request.objects[i].path)==undefined){
								numofobjects++;
							}
							storeObject(request.objects[i]);
						}
						printLogLine((numofobjects-start) + " objects have been saved from the request",mysession);
						if(numofobjects<maxnumofobjects){
							this.createnextlevel();
						}
						else{
							printLogLine("we finished the creation of objects, number is: "+numofobjects,mysession);
						}
					};
					myproject.onopen = function(){
						printLogLine("The project have been opened",mysession);
						var request = myproject.createRequest();
						printLogLine("creating the next request",mysession);
						request.ondone = function(){
							printLogLine("request handled by the server", mysession);
							myproject.saverequest(this);
						};
						var root = {};root.name = "root"; root.path="root";root.children=[];
						var rhash = request.saveObject(root);
						request.saveRoot(rhash);
						printLogLine("sending out the request",mysession);
						request.send();
					}

					/*the opening of the project happens here actually*/
					myproject.open();

				};
				
				printLogLine = function(line,session){
					var old = document.getElementById("LogContainer").innerHTML;
					document.getElementById("LogContainer").innerHTML = old + "[" + Date.parse(new Date()) + "]" + line + "{" + session + "}<br />";
				};
				
			});
		</script>
	</head>
	<body>
		<input type="text" id="NumberOfChildField" /><input type="text" id="NumberOfObjectsToBeCreatedField" /><br />
		<input type="button" id="StartCreationButton" value="Start" onclick="createProject()" />
		<div id="LogContainer">Here will be the logs and timings of the run...<br /></div>
	</body>
</html>