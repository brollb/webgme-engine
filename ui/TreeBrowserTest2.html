<!DOCTYPE html>
<html>
<head>
    <title>TreeBrowser test</title>

    <!-- CSS libraries -->
    <link href="css/main.css" type="text/css" rel="stylesheet"/>
    <link href="css/dynatree/ui.dynatree.css" rel="stylesheet" type="text/css">
    <!-- // CSS libraries -->

    <!-- JS libraries -->
    <script type="text/javascript" src="js/jquery.min.js"></script>
    <script type="text/javascript" src="js/jquery-ui.min.js"></script>
    <script type="text/javascript" src="js/jquery.dynatree.min.js"></script>
    <script type="text/javascript" src="js/jquery.jstree.js"></script>
    <script type="text/javascript" src="js/TreeBrowserWidget.js"></script>
    <script type="text/javascript" src="js/JSTreeBrowserWidget.js"></script>
    <!-- // External JS libraries -->

    <script type="text/javascript">

        /*********
         * UTILITY HELPERS
         */

        function S4() {
            return (((1+Math.random())*0x10000)|0).toString(16).substring(1);
        }

        function guid() {
            return (S4()+S4()+"-"+S4()+"-"+S4()+"-"+S4()+"-"+S4()+S4()+S4());
        }

        function logMessage( msg, enabled )
        {
            enabled = enabled || false;

            if ( enabled == true )
            {
                if ( window.console ) {
                    var d = new Date();
                    console.log( d.getHours() + ":" + d.getMinutes() + ":" + d.getSeconds() + "." + d.getMilliseconds() + ": " + msg );
                }
            }
        }

        (function($) {
            $.QueryString = (function(a) {
                if (a == "") return {};
                var b = {};
                for (var i = 0; i < a.length; ++i)
                {
                    var p=a[i].split('=');
                    if (p.length != 2) continue;
                    b[p[0]] = decodeURIComponent(p[1].replace(/\+/g, " "));
                }
                return b;
            })(window.location.search.substr(1).split('&'))
        })(jQuery);

        function TryParseInt(str,defaultValue){
            var retValue = defaultValue;
            if(str!=null){
                if(str.length>0){
                    if (!isNaN(str)){
                        retValue = parseInt(str);
                    }
                }
            }
            return retValue;
        }

        var treeBrowser = null;

        /*********
         * DOCUMENT READY
         */
        $(document).ready(function(){
            treeBrowser = new JSTreeBrowserWidget( "dTreeBrowser" );

            var refreshCycle = 1;

            var queryNode = $.QueryString["n"];

            var maxSublevel = TryParseInt(queryNode, 2);




            var startTreeTest = function() {
                window.logMessage( "RefreshCycle " + refreshCycle + " START", true );

                var startTime = new Date();

                //set initial variable values
                var counter = 0;

                var createChildNodes = function( parent, subLevel ) {
                    for ( var i = 0; i < 10; i++ ) {
                        var childNode = treeBrowser.createNode( parent, { name: "Node" + counter, hasChildren : true } );
                        counter += 1;

                        if ( subLevel > 1) {
                            createChildNodes( childNode, subLevel - 1  );
                        }
                    }
                }

                //create all the childs
                createChildNodes( null, maxSublevel );

                var checkPoint = function ( checkPointTitle ) {
                    var endTime = new Date();

                    var deltaMillisec = ( endTime.getTime() - startTime.getTime() ) / 1000;

                    var startMilSecStr = startTime.getMilliseconds();
                    if ( startTime.getMilliseconds() < 10 ) {
                        startMilSecStr = "00" + startMilSecStr;
                    } else {
                        if ( startTime.getMilliseconds() < 100 ) {
                            startMilSecStr = "0" + startMilSecStr;
                        }
                    }

                    var endMilSecStr = endTime.getMilliseconds();
                    if ( endTime.getMilliseconds() < 10 ) {
                        endMilSecStr = "00" + endMilSecStr;
                    } else {
                        if ( endTime.getMilliseconds() < 100 ) {
                            endMilSecStr = "0" + endMilSecStr;
                        }
                    }


                    var msg = checkPointTitle + " --- StartTime: " + startTime.getHours() + ":" + startTime.getMinutes() + ":" + startTime.getSeconds() + "." + startMilSecStr + ", EndTime:" + endTime.getHours() + ":" + endTime.getMinutes() + ":" + endTime.getSeconds() + "." +endMilSecStr;
                    msg += ", DURATION: " + deltaMillisec + " sec" + ", NODES: " + counter;

                    window.logMessage(msg, true );
                }

                checkPoint( "TREE-HIERARCHY-DONE" );

                //expand tree
                treeBrowser.expandTree();

                checkPoint( "TREE-EXPANDED" );

                //log refresh cycle end
                window.logMessage( "RefreshCycle " + refreshCycle + " END", true );

                //increment counter and start again
                refreshCycle += 1;

                setTimeout( function() {
                 //clear tree
                 treeBrowser.clear();
                 setTimeout( startTreeTest, 1000  );
                 }, 1000);

            }

            startTreeTest();

            //toplevel items
            /*var node1 = treeBrowser.createNode( null, { name: "Node1", hasChildren : true } );
            var node2 = treeBrowser.createNode( null, { name: "Node2", hasChildren : true } );
            var node3 = treeBrowser.createNode( null, { name: "Node3", hasChildren : true } );
            var node4 = treeBrowser.createNode( null, { name: "Node4", hasChildren : true } );
            var node5 = treeBrowser.createNode( null, { name: "Node5", hasChildren : false } );

            //remove node3 just for fun
            treeBrowser.deleteNode(node3);

            //handle node open
            treeBrowser.onNodeOpen = function( node ) {
                var that = this;
                setTimeout( function () {
                    that.createNode( node, { name: "Child1", hasChildren : false } );
                    that.createNode( node, { name: "Child2", hasChildren : false } );
                    that.createNode( node, { name: "Child3", hasChildren : false } );
                    that.createNode( node, { name: "Child4", hasChildren : false } );
                }, 1000 );
            }

            //node3 does not exist but try to rename it
            treeBrowser.setCustomData( node3, { x: "soonToBeDeleted" } );
            setTimeout( function() { treeBrowser.renameNode( node3, "Node3 upadted" ); }, 2000 );

            //node4 rename
            treeBrowser.setCustomData( node4, { x: 1, y: 2 } );
            setTimeout( function() { treeBrowser.renameNode( node4, "Node4 updated" ); }, 4000 );


            //create new child to node1
            treeBrowser.setCustomData( node1, { a: 1, b: 2, c: node4 } );
            setTimeout( function() {
                var node1_1 = treeBrowser.createNode( node1, { name: "Child5_autoadded", hasChildren : false } );
                //window.logMessage( node1_1.getParent() );

            }, 5000 );

            var customData4 = treeBrowser.getCustomData( node4 );
            var customData1 = treeBrowser.getCustomData( node1 );
            var customData3 = treeBrowser.getCustomData( node3);

            /*treeBrowser.onNodeTitleChanged = function( node, oldText, newText ) {
             //accept namechange
             return false;
             }*/
        });
    </script>
</head>
<body>
<div id="dTreeBrowser">
</div>
</body>
</html>