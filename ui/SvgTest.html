<!DOCTYPE html>
<html>
<head>
    <title>SVG test</title>

    <!-- CSS libraries -->
    <link href="css/main.css" type="text/css" rel="stylesheet"/>
    <link href="css/temp.css" type="text/css" rel="stylesheet"/>
    <!-- // CSS libraries -->

    <!-- JS libraries -->
    <script type="text/javascript" src="js/jquery.min.js"></script>
    <script type="text/javascript" src="js/jquery-ui.min.js"></script>
    <script type="text/javascript" src="js/raphael-min.js"></script>
    <!-- // External JS libraries -->

    <script type="text/javascript">

        /*********
         * UTILITY HELPERS
         */

        function S4() {
            return (((1+Math.random())*0x10000)|0).toString(16).substring(1);
        }

        function guid() {
            return (S4()+S4()+"-"+S4()+"-"+S4()+"-"+S4()+"-"+S4()+S4()+S4());
        }

        function logMessage( msg, enabled )
        {
            enabled = enabled || false;

            if ( enabled == true )
            {
                if ( window.console ) {
                    var d = new Date();
                    console.log( d.getHours() + ":" + d.getMinutes() + ":" + d.getSeconds() + "." + d.getMilliseconds() + ": " + msg );
                }
            }
        }

        (function($) {
            $.QueryString = (function(a) {
                if (a == "") return {};
                var b = {};
                for (var i = 0; i < a.length; ++i)
                {
                    var p=a[i].split('=');
                    if (p.length != 2) continue;
                    b[p[0]] = decodeURIComponent(p[1].replace(/\+/g, " "));
                }
                return b;
            })(window.location.search.substr(1).split('&'))
        })(jQuery);

        function TryParseInt(str,defaultValue){
            var retValue = defaultValue;
            if(str!=null){
                if(str.length>0){
                    if (!isNaN(str)){
                        retValue = parseInt(str);
                    }
                }
            }
            return retValue;
        }

        var paper = null;

        var svgns = "http://www.w3.org/2000/svg";

        /*********
         * DOCUMENT READY
         */
        $(document).ready(function(){

            var refreshCycle = 1;

            var queryNode = $.QueryString["n"];

            var noLoop = $.QueryString["noloop"];

            var maxSublevel = TryParseInt(queryNode, 2);

            //paper = Raphael( "mainContainer", "100%", "100%" );

            var mySvg = document.getElementById("mySvg");
            var svgDocument = mySvg.ownerDocument;

            var startTreeTest = function() {
                window.logMessage( "RefreshCycle " + refreshCycle + " START", true );

                var startTime = new Date();

                var topLevelG = svgDocument.createElementNS(svgns, "g");

                //set initial variable values
                var counter = 0;

                var cx = 30;
                var cy = 30;

                var createChildNodes = function( parent, subLevel ) {
                    for ( var i = 0; i < 10; i++ ) {

                        var g = svgDocument.createElementNS(svgns, "g");

                        var shape = svgDocument.createElementNS(svgns, "circle");
                        shape.setAttributeNS(null, "cx", cx);
                        shape.setAttributeNS(null, "cy", cy);
                        shape.setAttributeNS(null, "r",  20);
                        shape.setAttributeNS(null, "fill", "green");

                        g.appendChild(shape);

                        parent.appendChild(g);

                        counter += 1;

                        cx += 50;

                        if ( counter % 40 === 0 ) {
                            cy += 50;
                            cx = 30;
                        }

                        if ( subLevel > 1) {
                            createChildNodes( g, subLevel - 1  );
                        }


                    }
                }

                //create all the childs
                createChildNodes( topLevelG, maxSublevel );

                mySvg.appendChild(topLevelG);

                var checkPoint = function ( checkPointTitle ) {
                    var endTime = new Date();

                    var deltaMillisec = ( endTime.getTime() - startTime.getTime() ) / 1000;

                    var startMilSecStr = startTime.getMilliseconds();
                    if ( startTime.getMilliseconds() < 10 ) {
                        startMilSecStr = "00" + startMilSecStr;
                    } else {
                        if ( startTime.getMilliseconds() < 100 ) {
                            startMilSecStr = "0" + startMilSecStr;
                        }
                    }

                    var endMilSecStr = endTime.getMilliseconds();
                    if ( endTime.getMilliseconds() < 10 ) {
                        endMilSecStr = "00" + endMilSecStr;
                    } else {
                        if ( endTime.getMilliseconds() < 100 ) {
                            endMilSecStr = "0" + endMilSecStr;
                        }
                    }


                    var msg = checkPointTitle + " --- StartTime: " + startTime.getHours() + ":" + startTime.getMinutes() + ":" + startTime.getSeconds() + "." + startMilSecStr + ", EndTime:" + endTime.getHours() + ":" + endTime.getMinutes() + ":" + endTime.getSeconds() + "." +endMilSecStr;
                    msg += ", DURATION: " + deltaMillisec + " sec" + ", NODES: " + counter;

                    window.logMessage(msg, true );
                }

                checkPoint( "HIERARCHY-DONE" );

                //log refresh cycle end
                window.logMessage( "RefreshCycle " + refreshCycle + " END", true );

                //increment counter and start again
                refreshCycle += 1;

                if ( ! noLoop ) {

                    setTimeout( function() {
                        //clear tree
                        mySvg.removeChild(topLevelG);
                        setTimeout( startTreeTest, 2000  );
                    }, 2000);
                }

            }

            startTreeTest();
        });
    </script>
</head>
<body>
<div id="mainContainer">
    <svg xmlns="http://www.w3.org/2000/svg" version="1.1" id="mySvg" width="10000" height="10000">
    </svg>
</div>

</body>
</html>